// Cloudflare Worker (save as index.js)
// Set your OpenAI key as a Worker secret: wrangler secret put OPENAI_API_KEY
export default {
  async fetch(req, env) {
    const cors = {
      'Access-Control-Allow-Origin': req.headers.get('Origin') || '*', // lock to your Pages origin later
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
    };
    if (req.method === 'OPTIONS') return new Response('', { headers: cors });

    if (new URL(req.url).pathname !== '/chat') {
      return new Response(JSON.stringify({ error: 'Not found' }), { status: 404, headers: { ...cors, 'Content-Type': 'application/json' } });
    }

    try {
      const { model = 'gpt-4o-mini', system = 'You are Jarvis, a helpful, direct assistant.', messages = [] } = await req.json();

      const body = {
        model,
        messages: [
          { role: 'system', content: system },
          ...messages.map(m => ({ role: m.role, content: m.content })),
        ],
      };

      const r = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(body),
      });

      if (!r.ok) {
        const text = await r.text();
        return new Response(JSON.stringify({ error: text }), { status: 500, headers: { ...cors, 'Content-Type': 'application/json' } });
        }

      const data = await r.json();
      const reply = data.choices?.[0]?.message?.content ?? '';
      return new Response(JSON.stringify({ reply }), { headers: { ...cors, 'Content-Type': 'application/json' } });
    } catch (e) {
      return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: { ...cors, 'Content-Type': 'application/json' } });
    }
  }
}
